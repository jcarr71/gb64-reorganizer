# Copilot Instructions - GameBase64 Game Organizer

## Project Overview

A dual-interface Python tool (CLI + GUI) for organizing GameBase64 game collections from zip archives into structured folder hierarchies. The tool:
- Extracts games from zipped archives (designed for GameBase collections: C64, Amiga, etc.)
- Parses VERSION.NFO metadata files to extract 15+ fields (name, genre, publisher, year, credits, etc.)
- Creates customizable folder structures using template placeholders
- Renames multi-disk files to standardized format (`gamename_d1`, `gamename_d2`, etc.)
- Provides comprehensive logging and error reporting

**Key insight**: This is a metadata extraction and file organization tool, not a game emulator or runtime system.

## Architecture & Components

### Core Module: `GamebaseOrganizer` Class
Located in [gb64_reorganizer.py](../gb64_reorganizer.py), this single class encapsulates the entire workflow:

1. **Zip Extraction**: Uses `tempfile.mkdtemp()` for safe temporary extraction
2. **Metadata Parsing**: Regex-based VERSION.NFO parser extracting 15 fields (name, genres, language, published year, publisher, developer, players, control, PAL/NTSC, unique ID, credits)
3. **Template System**: `build_destination_path()` supports customizable folder structures with placeholder substitution (e.g., `{primary_genre}/{published_year}/{name}`)
4. **File Organization**: Copies extracted games to destination structure, renames disk files, handles duplicates
5. **Disk File Renaming**: Detects C64 disk formats (.d64, .d71, .d81, .g64, .x64, .t64, .tap, .prg, .p00, .lnx) and renames to `gamename_d{N}`

### GUI Module: `GamebaseGameOrganizerGUI` Class
Located in [gb64_gui.py](../gb64_gui.py), a tkinter-based interface:

1. **Background Scanning**: `GamebaseGameScannerThread` parses all zips asynchronously, populates game list with metadata preview
2. **Selection & Filtering**: Treeview with checkboxes for selective organization, filter by genre/language/publisher
3. **Template Customization**: Input field with help dialog showing 15 available placeholders
4. **Background Organization**: `GamebaseOrganizationThread` processes selected games without blocking UI

### Data Flow
```
User Input → Scan source dir for *.zip files 
→ Extract to temp → Find VERSION.NFO recursively
→ Parse metadata (regex, 15 fields) → Build path from template
→ Sanitize filenames (Windows-safe) → Rename disk files 
→ Copy to destination → Handle duplicates ([v2], [v3]) → Log results
```

## Critical Developer Workflows

### Building Executables
**CLI Version** (console):
```powershell
pyinstaller --onefile --name GB64GameOrganizer gb64_reorganizer.py
```

**GUI Version** (windowed, preferred):
```powershell
./build.ps1  # Recommended - auto-installs PyInstaller if missing
# Or manually:
pyinstaller --onefile --windowed --name GamebaseGameOrganizer gb64_gui.py
```

- Output: `./dist/GamebaseGameOrganizer.exe` (or `GB64GameOrganizer.exe` for CLI)
- Build config: `GB64GameOrganizer.spec` (auto-generated by PyInstaller)
- The `--windowed` flag suppresses console window for GUI builds

### Testing & Local Development
**CLI**:
```powershell
python gb64_reorganizer.py
```

**GUI**:
```powershell
python gb64_gui.py
```

**Safety features**:
- Default mode: `move_files=False` (copies files, never modifies originals)
- Temporary extraction directories auto-cleaned via `shutil.rmtree()` in `finally` blocks
- All file operations are non-destructive to source zips
- Test with small game subsets before processing entire libraries

**Output logs**:
- `organization_log.txt` created in destination directory
- Contains processing results, errors, duplicates
- Console output mirrors log file

### Version Management
See [VERSION_MANAGEMENT.md](../VERSION_MANAGEMENT.md) for full guide:
- **v1.0.0**: Fixed folder structure (Genre/SubGenre/Language/Name)
- **v1.0.1+**: Template system with 15 placeholders
- Switch versions: `git checkout v1.0.0` or `git checkout v1.0.1`
- Tags maintained on GitHub for stable releases

## Project-Specific Patterns & Conventions

### Pattern 1: Regex-Based Metadata Parsing
The VERSION.NFO parser uses encoding fallback strategy and specific regex patterns:

**Encoding strategy** (lines 85-105):
1. Try strict mode: `utf-8-sig`, `cp1252`, `latin-1`
2. Fallback to `errors='replace'` if strict fails
3. Handles malformed NFO files gracefully

**Regex patterns** (lines 107-226):
- **Multi-line fields**: `re.DOTALL` flag captures Genre spanning multiple lines
- **Line anchors**: `^\s*Name:` matches field at line start within GAME INFO section
- **Genre splitting**: Splits on " - " separator; defaults secondary_genre to "Other" if not found
- **Published parsing**: Extracts year (4-digit with optional `?`) and publisher from "YEAR Publisher" format
- **Safe defaults**: Language defaults to "(No Text)", most fields default to "Unknown" or `None`

### Pattern 2: Template System with 15 Placeholders
`build_destination_path()` (lines 244-277) supports dynamic folder structures:

**Available fields**:
```python
{name}, {primary_genre}, {secondary_genre}, {language}
{published_year}, {publisher}, {developer}
{players}, {control}, {pal_ntsc}
{unique_id}, {coding}, {graphics}, {music}, {comment}
```

**Example templates**:
- Default: `{primary_genre}/{secondary_genre}/{language}/{name}`
- By year: `{published_year}/{primary_genre}/{name}`
- By publisher: `{publisher}/{name}`

All placeholders auto-sanitized for Windows filenames before substitution.

### Pattern 3: Sanitization for Windows Compatibility
Two-step sanitization in `sanitize_folder_name()` (lines 279-295):
1. Remove invalid Windows chars: `<>:"|?*` via regex `r'[<>:"|?*]'`
2. Strip leading/trailing spaces and dots: `.strip('. ')`

Applied to all user-visible folder names (game names, genres, publisher, etc.)

### Pattern 4: Duplicate Handling with Version Numbering
When destination folder exists (lines 416-420 in `_process_zip_file()`):
```python
version = 2
while final_dest.exists():
    versioned_name = f"{game_name} [v{version}]"
    final_dest = dest_path / versioned_name
    version += 1
```
All duplicates logged to errors list for transparency.

### Pattern 5: Threading in GUI (gb64_gui.py)
**Scanner thread** (lines 45-103): Parses all zips in background, sends `GameInfo` objects to queue
**Organization thread** (lines 106-192): Processes selected games, sends log messages to queue
**Queue polling** (GUI main loop): Checks queue every 100ms to update UI without blocking

Uses `threading.Thread(daemon=True)` for automatic cleanup on exit.

## Key Dependencies & External Integration

- **No external dependencies**: Uses only Python standard library
  - `pathlib.Path` for cross-platform paths
  - `zipfile` for extraction
  - `tempfile.mkdtemp()` for safe temporary directories
  - `shutil` for copying/removing directories
  - `re` for regex parsing
  - `typing` for type hints
  - `tkinter` for GUI (built into Python on Windows)
  - `threading` and `queue` for GUI background operations

- **GameBase expectation**: Source directory must contain .zip files with VERSION.NFO inside

- **Windows compatibility**: Uses `shutil` cross-platform APIs and regex patterns designed for Windows filenames

## Important Implementation Details

1. **Genre splitting** (line 136): Only splits primary/secondary if " - " separator exists, otherwise primary_genre gets full text and secondary_genre defaults to "Other"

2. **NFO recursive search** (lines 238-242): Searches entire extracted folder tree recursively - handles nested folder structures where VERSION.NFO may be in subdirectories

3. **Disk file ordering** (line 267): Files sorted before renaming ensures consistent d1, d2, d3 ordering across runs

4. **Progress output**: Uses emoji indicators in console output (✓, ✗, ⚠) for visual scanning of results and errors

5. **Logging**: Creates `organization_log.txt` in destination directory with duplicate of console output - enables reviewing results after completion

6. **Error collection strategy** (lines 45, 70, 237): Uses `self.errors` list to collect all issues (metadata failures, missing NFO, duplicates) and displays them at end of run - provides complete failure audit trail

7. **Null safety in parsing**: `parse_version_nfo()` returns `None` on any parsing failure; this triggers graceful skip with detailed error rather than crashing

8. **Published field parsing** (lines 145-159): Validates year format (4 chars, digits or `?`), splits year from publisher on first space

9. **Game folder detection** (lines 394, 150-154 in GUI): After NFO found, uses its parent directory as game folder - handles cases where zip contains wrapper folder

10. **GUI game list**: Uses `ttk.Treeview` with custom checkboxes for selection, displays 8 metadata columns (Name, Genre, Language, Year, Publisher, Players, Control, PAL/NTSC)

## Common Modifications

- Adding new disk file extensions: Edit `disk_extensions` set in `rename_disk_files()` (line 260)
- Changing default template: Modify `folder_template` parameter in `organize_games()` (line 331)
- Supporting additional metadata fields: 
  1. Add regex pattern in `parse_version_nfo()` (lines 70-237)
  2. Add field to returned dictionary (lines 219-235)
  3. Add placeholder in `build_destination_path()` (lines 244-277)
  4. Update GUI columns if needed
- Customizing error handling: Modify exception handlers in try/finally blocks
